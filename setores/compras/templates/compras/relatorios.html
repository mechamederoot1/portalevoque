<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Relatórios - Evoque Fitness</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- SheetJS for Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary-color: #FF6200;
      --secondary-color: #1C2526;
      --accent-color: #FF914D;
      --dark-color: #2A2F30;
      --light-color: #F8F9FA;
      --text-color: #F8F9FA;
      --text-light: #bfc7ca;
      --card-bg: #2A2F30;
      --border-color: #3A4345;
      --shadow-color: rgba(0,0,0,0.3);
    }

    body {
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background-color: var(--secondary-color);
      color: var(--text-color) !important;
      font-weight: 500;
      line-height: 1.6;
    }

    .navbar-brand, .nav-link {
      color: var(--text-color) !important;
    }
    
    .navbar {
      background-color: var(--dark-color) !important;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .main-content {
      margin-top: 80px;
      padding: 40px 0;
    }
    
    .card {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      box-shadow: 0 4px 12px var(--shadow-color);
    }

    .card-header {
      background-color: rgba(255, 98, 0, 0.1);
      border-bottom: 1px solid var(--border-color);
      color: var(--text-color) !important;
    }

    .card-title {
      color: var(--primary-color) !important;
      font-weight: 600;
    }

    .page-title {
      color: var(--primary-color) !important;
      border-bottom: 3px solid var(--primary-color);
      padding-bottom: 10px;
      margin-bottom: 30px;
      font-weight: 700;
    }
    
    .stats-card {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      border: none;
      color: white;
    }
    
    .stats-value {
      font-size: 2.5rem;
      font-weight: 700;
    }
    
    .form-control, .form-select {
      background-color: var(--secondary-color);
      border: 1px solid var(--border-color);
      color: var(--text-color) !important;
      font-weight: 500;
    }

    .form-control:focus, .form-select:focus {
      background-color: var(--secondary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(255, 98, 0, 0.25);
      color: var(--text-color) !important;
    }

    /* Garantir que todo texto seja visível */
    * {
      color: inherit;
    }

    p, span, div, label, input, select, textarea, h1, h2, h3, h4, h5, h6, td, th {
      color: var(--text-color) !important;
    }

    .table-dark {
      --bs-table-bg: var(--card-bg);
      --bs-table-color: var(--text-color);
    }
    
    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    .chart-container {
      position: relative;
      height: 400px;
    }
    
    .table-dark {
      --bs-table-bg: var(--dark-color);
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('main.index') }}">
        <img src="https://images.totalpass.com/public/1280x720/czM6Ly90cC1pbWFnZS1hZG1pbi1wcm9kL2d5bXMvNHVrOWtkOGd3M2xlMXg4OGNzdzViN2NhdmUzY2hhNWV3Y2lyd2pyNmI4djl6aXdiNTV2YXg3bjJ2aDI2" alt="Evoque Fitness" height="40">
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="{{ url_for('compras.index') }}">
          <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
      </div>
    </div>
  </nav>

  <div class="main-content">
    <div class="container">
      <h1 class="page-title">
        <i class="fas fa-chart-pie me-3"></i>Relatórios de Compras
      </h1>
      
      <!-- Filtros Gerais -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-filter me-2"></i>Filtros
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 mb-3">
              <label for="dataInicio" class="form-label">Data Início</label>
              <input type="date" class="form-control" id="dataInicio">
            </div>
            <div class="col-md-3 mb-3">
              <label for="dataFim" class="form-label">Data Fim</label>
              <input type="date" class="form-control" id="dataFim">
            </div>
            <div class="col-md-3 mb-3">
              <label for="filtroCategoria" class="form-label">Categoria</label>
              <select class="form-select" id="filtroCategoria">
                <option value="">Todas as categorias</option>
                <option value="equipamentos">Equipamentos</option>
                <option value="materiais">Materiais</option>
                <option value="servicos">Serviços</option>
                <option value="manutencao">Manutenção</option>
                <option value="limpeza">Limpeza</option>
              </select>
            </div>
            <div class="col-md-3 mb-3 d-flex align-items-end">
              <button class="btn btn-primary w-100" onclick="atualizarRelatorios()">
                <i class="fas fa-chart-bar me-2"></i>Gerar Relatório
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Cards de Estatísticas -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body text-center">
              <i class="fas fa-shopping-cart fa-3x mb-3"></i>
              <div class="stats-value" id="totalSolicitacoes">42</div>
              <div>Total de Solicitações</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body text-center">
              <i class="fas fa-dollar-sign fa-3x mb-3"></i>
              <div class="stats-value" id="valorTotal">R$ 125.430</div>
              <div>Valor Total</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body text-center">
              <i class="fas fa-check-circle fa-3x mb-3"></i>
              <div class="stats-value" id="aprovadas">85%</div>
              <div>Taxa de Aprovação</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card stats-card">
            <div class="card-body text-center">
              <i class="fas fa-clock fa-3x mb-3"></i>
              <div class="stats-value" id="tempoMedio">3.2</div>
              <div>Dias Médios p/ Entrega</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Gráficos -->
      <div class="row mb-4">
        <div class="col-lg-8 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-line me-2"></i>Solicitaç��es por Mês
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chartMensal"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-pie me-2"></i>Por Categoria
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chartCategorias"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-chart-bar me-2"></i>Status das Solicitações
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chartStatus"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="fas fa-truck me-2"></i>Top 5 Fornecedores
              </h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chartFornecedores"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabela Detalhada -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-table me-2"></i>Relatório Detalhado
          </h5>
          <div>
            <button class="btn btn-success btn-sm me-2" onclick="exportarExcel()">
              <i class="fas fa-file-excel me-1"></i>Excel
            </button>
            <button class="btn btn-danger btn-sm" onclick="exportarPDF()">
              <i class="fas fa-file-pdf me-1"></i>PDF
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-dark table-striped table-hover" id="tabelaRelatorio">
              <thead>
                <tr>
                  <th>Protocolo</th>
                  <th>Data</th>
                  <th>Produto</th>
                  <th>Categoria</th>
                  <th>Valor</th>
                  <th>Status</th>
                  <th>Fornecedor</th>
                </tr>
              </thead>
              <tbody>
                <!-- Dados serão carregados dinamicamente -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Dados de exemplo
    const dadosExemplo = [
      { protocolo: 'COMP-20250101001', data: '01/01/2025', produto: 'Esteiras Profissionais', categoria: 'equipamentos', valor: 15000, status: 'entregue', fornecedor: 'TechFit' },
      { protocolo: 'COMP-20250102002', data: '02/01/2025', produto: 'Material de Limpeza', categoria: 'limpeza', valor: 350, status: 'aprovado', fornecedor: 'Clean Services' },
      { protocolo: 'COMP-20250103003', data: '03/01/2025', produto: 'Manutenção Ar Condicionado', categoria: 'manutencao', valor: 800, status: 'processando', fornecedor: 'Manutenção Total' },
      { protocolo: 'COMP-20250104004', data: '04/01/2025', produto: 'Papel A4', categoria: 'materiais', valor: 120, status: 'pendente', fornecedor: 'Office Supplies' }
    ];

    // Configuração dos gráficos
    const configGrafico = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: {
            color: '#F8F9FA'
          }
        }
      },
      scales: {
        y: {
          ticks: {
            color: '#F8F9FA'
          },
          grid: {
            color: '#3A4345'
          }
        },
        x: {
          ticks: {
            color: '#F8F9FA'
          },
          grid: {
            color: '#3A4345'
          }
        }
      }
    };

    function inicializarGraficos() {
      // Gráfico Mensal
      const ctxMensal = document.getElementById('chartMensal').getContext('2d');
      new Chart(ctxMensal, {
        type: 'line',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
          datasets: [{
            label: 'Solicitações',
            data: [12, 19, 8, 15, 22, 18],
            borderColor: '#FF6200',
            backgroundColor: 'rgba(255, 98, 0, 0.1)',
            tension: 0.4
          }]
        },
        options: configGrafico
      });

      // Gráfico de Categorias
      const ctxCategorias = document.getElementById('chartCategorias').getContext('2d');
      new Chart(ctxCategorias, {
        type: 'doughnut',
        data: {
          labels: ['Equipamentos', 'Limpeza', 'Manutenção', 'Materiais'],
          datasets: [{
            data: [35, 25, 20, 20],
            backgroundColor: ['#FF6200', '#FF914D', '#FFA366', '#FFB580']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#F8F9FA'
              }
            }
          }
        }
      });

      // Gráfico de Status
      const ctxStatus = document.getElementById('chartStatus').getContext('2d');
      new Chart(ctxStatus, {
        type: 'bar',
        data: {
          labels: ['Pendente', 'Aprovado', 'Processando', 'Entregue'],
          datasets: [{
            label: 'Quantidade',
            data: [5, 12, 8, 17],
            backgroundColor: ['#ffc107', '#28a745', '#17a2b8', '#6f42c1']
          }]
        },
        options: configGrafico
      });

      // Gráfico de Fornecedores
      const ctxFornecedores = document.getElementById('chartFornecedores').getContext('2d');
      new Chart(ctxFornecedores, {
        type: 'horizontalBar',
        data: {
          labels: ['TechFit', 'Clean Services', 'Manutenção Total', 'Office Supplies'],
          datasets: [{
            label: 'Pedidos',
            data: [15, 12, 8, 7],
            backgroundColor: '#FF6200'
          }]
        },
        options: configGrafico
      });
    }

    function carregarTabelaRelatorio() {
      const tbody = document.querySelector('#tabelaRelatorio tbody');
      
      tbody.innerHTML = dadosExemplo.map(item => `
        <tr>
          <td><code>${item.protocolo}</code></td>
          <td>${item.data}</td>
          <td>${item.produto}</td>
          <td><span class="badge" style="background-color: var(--primary-color)">${item.categoria}</span></td>
          <td>R$ ${item.valor.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
          <td><span class="badge bg-${getStatusColor(item.status)}">${getStatusLabel(item.status)}</span></td>
          <td>${item.fornecedor}</td>
        </tr>
      `).join('');
    }

    function getStatusColor(status) {
      const colors = {
        pendente: 'warning',
        aprovado: 'success',
        processando: 'info',
        entregue: 'primary',
        rejeitado: 'danger'
      };
      return colors[status] || 'secondary';
    }

    function getStatusLabel(status) {
      const labels = {
        pendente: 'Pendente',
        aprovado: 'Aprovado',
        processando: 'Processando',
        entregue: 'Entregue',
        rejeitado: 'Rejeitado'
      };
      return labels[status] || status;
    }

    function atualizarRelatorios() {
      // Simular atualização dos dados
      console.log('Atualizando relatórios...');
      
      // Aqui você faria uma chamada para a API com os filtros
      const dataInicio = document.getElementById('dataInicio').value;
      const dataFim = document.getElementById('dataFim').value;
      const categoria = document.getElementById('filtroCategoria').value;
      
      // Recarregar dados
      carregarTabelaRelatorio();
      
      // Mostrar feedback
      const btn = event.target;
      const textoOriginal = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Atualizando...';
      btn.disabled = true;
      
      setTimeout(() => {
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
      }, 1000);
    }

    async function exportarExcel() {
      try {
        const btn = event.target;
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exportando...';
        btn.disabled = true;

        // Preparar dados para Excel
        const dadosExcel = [
          // Cabeçalho
          ['RELATÓRIO DE COMPRAS - EVOQUE FITNESS'],
          ['Gerado em: ' + new Date().toLocaleDateString('pt-BR')],
          [''],
          ['RESUMO EXECUTIVO'],
          ['Total de Solicitações', document.getElementById('totalSolicitacoes').textContent],
          ['Valor Total', document.getElementById('valorTotal').textContent],
          ['Taxa de Aprovação', document.getElementById('aprovadas').textContent],
          ['Tempo Médio de Entrega', document.getElementById('tempoMedio').textContent + ' dias'],
          [''],
          ['DETALHAMENTO DAS SOLICITAÇÕES'],
          ['Protocolo', 'Data', 'Produto', 'Categoria', 'Valor (R$)', 'Status', 'Fornecedor']
        ];

        // Adicionar dados da tabela
        dadosExemplo.forEach(item => {
          dadosExcel.push([
            item.protocolo,
            item.data,
            item.produto,
            item.categoria,
            item.valor,
            getStatusLabel(item.status),
            item.fornecedor
          ]);
        });

        // Adicionar análise por categoria
        dadosExcel.push(['']);
        dadosExcel.push(['ANÁLISE POR CATEGORIA']);
        dadosExcel.push(['Categoria', 'Quantidade', 'Percentual']);
        dadosExcel.push(['Equipamentos', '15', '35%']);
        dadosExcel.push(['Limpeza', '11', '25%']);
        dadosExcel.push(['Manutenção', '9', '20%']);
        dadosExcel.push(['Materiais', '9', '20%']);

        // Criar workbook
        const ws = XLSX.utils.aoa_to_sheet(dadosExcel);

        // Aplicar estilos ao cabeçalho
        ws['!merges'] = [
          { s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }, // Título principal
          { s: { r: 1, c: 0 }, e: { r: 1, c: 6 } }, // Data
          { s: { r: 3, c: 0 }, e: { r: 3, c: 6 } }, // Resumo
          { s: { r: 9, c: 0 }, e: { r: 9, c: 6 } }, // Detalhamento
          { s: { r: dadosExcel.length - 5, c: 0 }, e: { r: dadosExcel.length - 5, c: 6 } } // Análise
        ];

        // Configurar largura das colunas
        ws['!cols'] = [
          { wch: 20 }, // Protocolo
          { wch: 12 }, // Data
          { wch: 30 }, // Produto
          { wch: 15 }, // Categoria
          { wch: 15 }, // Valor
          { wch: 15 }, // Status
          { wch: 20 }  // Fornecedor
        ];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Relatório Compras');

        // Gerar arquivo
        const nomeArquivo = `relatorio_compras_${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, nomeArquivo);

        // Mostrar sucesso
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Exportado!';
        setTimeout(() => {
          btn.innerHTML = textoOriginal;
          btn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('Erro ao exportar Excel:', error);
        alert('Erro ao exportar Excel: ' + error.message);
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
      }
    }

    async function exportarPDF() {
      try {
        const btn = event.target;
        const textoOriginal = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Gerando PDF...';
        btn.disabled = true;

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('l', 'mm', 'a4'); // Paisagem

        let yPosition = 20;
        const leftMargin = 15;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // Cabeçalho
        pdf.setFontSize(20);
        pdf.setFont('helvetica', 'bold');
        pdf.text('RELATÓRIO DE COMPRAS - EVOQUE FITNESS', pageWidth/2, yPosition, { align: 'center' });

        yPosition += 10;
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'normal');
        pdf.text('Gerado em: ' + new Date().toLocaleDateString('pt-BR'), pageWidth/2, yPosition, { align: 'center' });

        yPosition += 20;

        // Resumo Executivo
        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.text('RESUMO EXECUTIVO', leftMargin, yPosition);
        yPosition += 15;

        pdf.setFontSize(11);
        pdf.setFont('helvetica', 'normal');
        const resumo = [
          ['Total de Solicitações:', document.getElementById('totalSolicitacoes').textContent],
          ['Valor Total:', document.getElementById('valorTotal').textContent],
          ['Taxa de Aprovação:', document.getElementById('aprovadas').textContent],
          ['Tempo Médio de Entrega:', document.getElementById('tempoMedio').textContent + ' dias']
        ];

        resumo.forEach(([label, value]) => {
          pdf.text(label, leftMargin, yPosition);
          pdf.text(value, leftMargin + 80, yPosition);
          yPosition += 8;
        });

        yPosition += 10;

        // Capturar gráficos
        const graficos = ['chartMensal', 'chartCategorias', 'chartStatus', 'chartFornecedores'];
        const titulosGraficos = ['Solicitações por Mês', 'Por Categoria', 'Status das Solicitações', 'Top 5 Fornecedores'];

        for (let i = 0; i < graficos.length; i++) {
          if (yPosition > pageHeight - 80) {
            pdf.addPage();
            yPosition = 20;
          }

          pdf.setFontSize(14);
          pdf.setFont('helvetica', 'bold');
          pdf.text(titulosGraficos[i], leftMargin, yPosition);
          yPosition += 10;

          try {
            const canvas = document.getElementById(graficos[i]);
            if (canvas) {
              const canvasImg = canvas.toDataURL('image/png', 1.0);
              const imgWidth = 120;
              const imgHeight = 80;

              pdf.addImage(canvasImg, 'PNG', leftMargin, yPosition, imgWidth, imgHeight);
              yPosition += imgHeight + 15;
            }
          } catch (chartError) {
            console.warn('Erro ao capturar gráfico:', chartError);
            pdf.text('Gráfico não disponível', leftMargin, yPosition);
            yPosition += 20;
          }
        }

        // Nova página para tabela detalhada
        pdf.addPage();
        yPosition = 20;

        pdf.setFontSize(16);
        pdf.setFont('helvetica', 'bold');
        pdf.text('DETALHAMENTO DAS SOLICITAÇÕES', leftMargin, yPosition);
        yPosition += 15;

        // Cabeçalho da tabela
        pdf.setFontSize(9);
        pdf.setFont('helvetica', 'bold');
        const headers = ['Protocolo', 'Data', 'Produto', 'Categoria', 'Valor', 'Status', 'Fornecedor'];
        const colWidths = [35, 25, 60, 25, 25, 25, 40];
        let xPosition = leftMargin;

        headers.forEach((header, index) => {
          pdf.text(header, xPosition, yPosition);
          xPosition += colWidths[index];
        });

        yPosition += 8;
        pdf.line(leftMargin, yPosition, pageWidth - 15, yPosition); // Linha horizontal
        yPosition += 5;

        // Dados da tabela
        pdf.setFont('helvetica', 'normal');
        dadosExemplo.forEach(item => {
          if (yPosition > pageHeight - 20) {
            pdf.addPage();
            yPosition = 20;
          }

          xPosition = leftMargin;
          const rowData = [
            item.protocolo,
            item.data,
            item.produto.length > 25 ? item.produto.substring(0, 25) + '...' : item.produto,
            item.categoria,
            'R$ ' + item.valor.toLocaleString('pt-BR'),
            getStatusLabel(item.status),
            item.fornecedor
          ];

          rowData.forEach((data, index) => {
            pdf.text(String(data), xPosition, yPosition);
            xPosition += colWidths[index];
          });
          yPosition += 7;
        });

        // Análise por categoria
        yPosition += 15;
        if (yPosition > pageHeight - 60) {
          pdf.addPage();
          yPosition = 20;
        }

        pdf.setFontSize(14);
        pdf.setFont('helvetica', 'bold');
        pdf.text('ANÁLISE POR CATEGORIA', leftMargin, yPosition);
        yPosition += 15;

        pdf.setFontSize(10);
        pdf.setFont('helvetica', 'normal');
        const categorias = [
          ['Equipamentos', '15 solicitações', '35%'],
          ['Limpeza', '11 solicitações', '25%'],
          ['Manutenção', '9 solicitações', '20%'],
          ['Materiais', '9 solicitações', '20%']
        ];

        categorias.forEach(([cat, qtd, perc]) => {
          pdf.text(`${cat}: ${qtd} (${perc})`, leftMargin, yPosition);
          yPosition += 8;
        });

        // Rodapé
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
          pdf.setPage(i);
          pdf.setFontSize(8);
          pdf.text(
            `Página ${i} de ${totalPages} | Evoque Fitness - Sistema de Compras`,
            pageWidth/2,
            pageHeight - 10,
            { align: 'center' }
          );
        }

        // Salvar PDF
        const nomeArquivo = `relatorio_compras_${new Date().toISOString().split('T')[0]}.pdf`;
        pdf.save(nomeArquivo);

        // Mostrar sucesso
        btn.innerHTML = '<i class="fas fa-check me-1"></i>PDF Gerado!';
        setTimeout(() => {
          btn.innerHTML = textoOriginal;
          btn.disabled = false;
        }, 2000);

      } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Erro ao gerar PDF: ' + error.message);
        btn.innerHTML = textoOriginal;
        btn.disabled = false;
      }
    }

    // Inicializar página
    document.addEventListener('DOMContentLoaded', function() {
      // Definir datas padrão (último mês)
      const hoje = new Date();
      const umMesAtras = new Date();
      umMesAtras.setMonth(hoje.getMonth() - 1);
      
      document.getElementById('dataInicio').value = umMesAtras.toISOString().split('T')[0];
      document.getElementById('dataFim').value = hoje.toISOString().split('T')[0];
      
      // Carregar dados
      carregarTabelaRelatorio();
      
      // Inicializar gráficos após um pequeno delay para garantir que o DOM esteja pronto
      setTimeout(inicializarGraficos, 100);
    });
  </script>
</body>
</html>
